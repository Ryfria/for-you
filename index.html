<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Special Message (No Cam UI)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }

        /* --- UI PANEL UTAMA (DIBUAT BESAR & KONTRAS) --- */
        #ui-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, #000 0%, rgba(10,10,20,0.95) 100%);
            padding: 20px 20px 40px 20px; 
            border-top: 2px solid #00d2ff; /* Garis Neon Biru di atas */
            color: #fff; z-index: 10; 
            box-sizing: border-box;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -10px 50px rgba(0, 210, 255, 0.2);
        }

        /* Video disembunyikan total (tapi tetap ada di memori) */
        #webcam-preview { display: none; } 

        /* Header Status */
        .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .main-title { font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .status-text { font-size: 16px; font-weight: bold; color: #ff3333; animation: pulse 1s infinite; }
        .status-text.ok { color: #00ffaa; animation: none; }

        /* --- GRID TOMBOL INSTRUKSI (BESAR) --- */
        .guide-container {
            display: grid; 
            grid-template-columns: 1fr 1fr; /* 2 Kolom */
            gap: 10px; 
            margin-top: 10px;
        }

        .guide-item {
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1);
            padding: 15px; 
            border-radius: 12px; 
            color: #aaa;
            font-size: 14px; 
            font-weight: 600;
            display: flex; align-items: center; justify-content: flex-start; gap: 10px;
            transition: all 0.2s ease;
        }

        .guide-item span { font-size: 20px; } /* Emoji besar */

        /* Jika Aktif (Highlight Terang) */
        .guide-item.active { 
            background: #00d2ff; 
            color: #000; 
            border-color: #fff;
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.6);
            transform: scale(1.02);
            font-weight: 800;
        }
        
        /* Baris khusus untuk LOVE (Full Width) */
        .guide-item.full-width { grid-column: span 2; justify-content: center; background: rgba(255, 0, 85, 0.1); border-color: rgba(255, 0, 85, 0.3); }
        .guide-item.full-width.active { background: #ff0055; color: white; }

        .loading-bar { width: 100%; height: 6px; background: #222; margin-top: 20px; border-radius: 10px; overflow: hidden; position: relative; }
        .loading-fill { height: 100%; width: 0%; background: #00ffaa; transition: width 0.1s; box-shadow: 0 0 10px #00ffaa; }

        #loading {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 18px; text-align: center; width: 80%;
            background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; border: 1px solid #333;
        }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>

    <video id="webcam-preview" playsinline muted autoplay></video>

    <div id="ui-panel">
        <div class="status-header">
            <div class="main-title">Deteksi Gaya</div>
            <div class="status-text" id="cam-status">Mencari Tangan...</div>
        </div>
        
        <div class="guide-container">
            <div class="guide-item" id="g-1"><span>‚òùÔ∏è</span> 1 Jari (Hai)</div>
            <div class="guide-item" id="g-2"><span>‚úåÔ∏è</span> 2 Jari (Puji)</div>
            <div class="guide-item" id="g-3"><span>ü§ü</span> 3 Jari (Thanks)</div>
            <div class="guide-item" id="g-4"><span>üññ</span> 4 Jari (Doa)</div>
            <div class="guide-item full-width" id="g-5"><span>‚úã</span> 5 Jari (Rentang) = ‚ù§Ô∏è</div>
        </div>

        <div class="loading-bar"><div class="loading-fill" id="stabilizer-bar"></div></div>
    </div>

    <div id="loading">
        System Start...<br>
        <span style="font-size:12px; color:#aaa; margin-top:5px; display:block;">Izinkan kamera (Berjalan di background)</span>
    </div>

    <div id="canvas-container"></div>
    <canvas id="textCanvas" width="1600" height="800" style="display:none;"></canvas>

<script>
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const PARTICLE_COUNT = isMobile ? 14000 : 25000;
    const STABILITY_THRESHOLD = 15; // Lebih cepat responnya
    
    let particles, geometry, material;
    let positions, targetPositions, colorsArray;
    let cacheIdle = [], cache1 = [], cache2 = [], cache3 = [], cache4 = [];
    let currentShapeType = 'idle';
    let physicsScale = 1.0;
    let lastDetectedShape = '';
    let displayedShape = '';
    let frameCounter = 0;
    const tempColor = new THREE.Color();

    // --- 1. THREE.JS SETUP ---
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.01); // Hitam pekat

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    
    function adjustCamera() {
        const aspect = window.innerWidth / window.innerHeight;
        // Kamera dimundurkan lagi supaya teks tidak tertutup UI Panel di bawah
        camera.position.z = aspect < 1 ? 100 : 60; 
        camera.position.y = aspect < 1 ? 10 : 0; // Naikkan sedikit kameranya
        camera.updateProjectionMatrix();
    }
    adjustCamera();

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    // --- 2. GENERATE TEXT (LEBIH TERANG) ---
    function generateTextPoints(text, size = 60) {
        const c = document.getElementById('textCanvas');
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,c.width,c.height);
        ctx.fillStyle = 'black'; ctx.fillRect(0,0,c.width,c.height);
        
        ctx.fillStyle = '#ffffff'; // Putih Murni
        ctx.font = `900 ${size}px Arial Black, sans-serif`;
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        
        const lines = text.split('\n');
        const lineHeight = size * 1.3;
        const startY = (c.height - ((lines.length - 1) * lineHeight)) / 2;

        lines.forEach((line, index) => {
            ctx.fillText(line, c.width/2, startY + (index * lineHeight));
        });
        
        const data = ctx.getImageData(0,0,c.width,c.height).data;
        const pts = [];
        const step = 4; // Ringan untuk HP
        for(let y=0; y<c.height; y+=step) {
            for(let x=0; x<c.width; x+=step) {
                if(data[(y*c.width+x)*4] > 128) {
                    pts.push({ x: (x - c.width/2)*0.1, y: ((c.height-y)-c.height/2)*0.1, z: 0 });
                }
            }
        }
        return pts;
    }

    // --- 3. PARTICLES ---
    function initParticles() {
        cacheIdle = generateTextPoints("Ada Pesan\nUntuk Kamu ü§ç", 60);
        cache1 = generateTextPoints("Hai Dini üå∏\nMaaf kalau risih..", 50);
        cache2 = generateTextPoints("Kamu Cantik\nNatural & Manis ‚ú®", 50);
        cache3 = generateTextPoints("Terima Kasih\nSudah Mampir üí´", 55);
        cache4 = generateTextPoints("Semoga Harimu\nSelalu Indah ü§ç", 55);

        geometry = new THREE.BufferGeometry();
        positions = new Float32Array(PARTICLE_COUNT * 3);
        targetPositions = new Float32Array(PARTICLE_COUNT * 3);
        colorsArray = new Float32Array(PARTICLE_COUNT * 3);

        for(let i=0; i<PARTICLE_COUNT*3; i++) {
            positions[i] = (Math.random()-0.5) * 100;
            targetPositions[i] = positions[i];
        }

        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colorsArray, 3));

        material = new THREE.PointsMaterial({
            size: isMobile ? 0.4 : 0.25, // Partikel lebih besar
            vertexColors: true, transparent: true, opacity: 1.0, 
            blending: THREE.AdditiveBlending, depthWrite: false
        });

        particles = new THREE.Points(geometry, material);
        scene.add(particles);
        calculateShape('idle');
    }

    // --- 4. ANIMATION LOGIC ---
    function triggerTransitionEffect(effectType) {
        const pos = geometry.attributes.position.array;
        for(let i=0; i<PARTICLE_COUNT; i++) {
            const i3 = i*3;
            if (effectType === 'explode') {
                pos[i3] += (Math.random()-0.5)*50; pos[i3+1] += (Math.random()-0.5)*50;
            } else if (effectType === 'rain') {
                pos[i3+1] += 50;
            } else if (effectType === 'warp') {
                pos[i3+2] += 80;
            }
        }
    }

    function calculateShape(type) {
        currentShapeType = type;
        document.querySelectorAll('.guide-item').forEach(el => el.classList.remove('active'));

        if(type === 'msg1') document.getElementById('g-1').classList.add('active');
        if(type === 'msg2') document.getElementById('g-2').classList.add('active');
        if(type === 'msg3') document.getElementById('g-3').classList.add('active');
        if(type === 'msg4') document.getElementById('g-4').classList.add('active');
        if(type === 'heart') document.getElementById('g-5').classList.add('active');

        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const i3 = i * 3;
            let x, y, z, hue;
            let pt;

            if (type === 'idle') {
                pt = cacheIdle[i % cacheIdle.length];
                x = pt.x; y = pt.y; z = pt.z + (Math.random()-0.5);
                hue = 0.6; // Biru Standby
            } 
            else if (type.startsWith('msg')) {
                let cache = type === 'msg1'?cache1 : type==='msg2'?cache2 : type==='msg3'?cache3 : cache4;
                pt = cache[i % cache.length];
                x = pt.x; y = pt.y; z = pt.z;
                hue = (x/50) + 0.5; // Warna-warni
            } 
            else if (type === 'heart') {
                const t = Math.random() * Math.PI * 2;
                let hx = 16 * Math.pow(Math.sin(t), 3);
                let hy = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                x = hx; y = hy + 5; z = (Math.random()-0.5)*5;
                hue = 0.95; // Merah/Pink
            } 
            else { x=0;y=0;z=0;hue=0; }

            targetPositions[i3] = x;
            targetPositions[i3+1] = y;
            targetPositions[i3+2] = z;

            tempColor.setHSL(hue % 1, 1.0, 0.6); // Full Saturation
            colorsArray[i3] = tempColor.r;
            colorsArray[i3+1] = tempColor.g;
            colorsArray[i3+2] = tempColor.b;
        }
        geometry.attributes.color.needsUpdate = true;
    }

    function animate() {
        requestAnimationFrame(animate);
        const time = Date.now() * 0.001;
        
        // Animasi floating pelan
        if(currentShapeType === 'idle') particles.rotation.y = Math.sin(time*0.5) * 0.1;
        else particles.rotation.y = 0;

        const pos = geometry.attributes.position.array;
        const lerpSpeed = 0.08;

        for(let i=0; i<PARTICLE_COUNT; i++) {
            const i3 = i*3;
            pos[i3] += (targetPositions[i3] * physicsScale - pos[i3]) * lerpSpeed;
            pos[i3+1] += (targetPositions[i3+1] * physicsScale - pos[i3+1]) * lerpSpeed;
            pos[i3+2] += (targetPositions[i3+2] * physicsScale - pos[i3+2]) * lerpSpeed;
        }
        geometry.attributes.position.needsUpdate = true;
        renderer.render(scene, camera);
    }

    // --- 5. DETEKSI TANGAN ---
    function detectGesture(landmarks) {
        const wrist = landmarks[0];
        const indexMCP = landmarks[5];
        const palmSize = Math.hypot(indexMCP.x - wrist.x, indexMCP.y - wrist.y);

        function isExtended(tipIdx, pipIdx) {
            const tipDist = Math.hypot(landmarks[tipIdx].x - wrist.x, landmarks[tipIdx].y - wrist.y);
            const pipDist = Math.hypot(landmarks[pipIdx].x - wrist.x, landmarks[pipIdx].y - wrist.y);
            return tipDist > pipDist && tipDist > (palmSize * 1.3);
        }

        const thumbTip = landmarks[4];
        const thumbDist = Math.hypot(thumbTip.x - indexMCP.x, thumbTip.y - indexMCP.y);
        const thumbUp = thumbDist > (palmSize * 0.8);

        const indexUp  = isExtended(8, 6);
        const middleUp = isExtended(12, 10);
        const ringUp   = isExtended(16, 14);
        const pinkyUp  = isExtended(20, 18);

        let fingerCount = 0;
        if (thumbUp) fingerCount++;
        if (indexUp) fingerCount++;
        if (middleUp) fingerCount++;
        if (ringUp) fingerCount++;
        if (pinkyUp) fingerCount++;

        // Update UI Status Teks
        const statusText = document.getElementById('cam-status');
        statusText.innerText = "Terdeteksi: " + fingerCount + " Jari";
        statusText.classList.add('ok');

        let potentialShape = currentShapeType;
        if (fingerCount === 5) potentialShape = 'heart';
        else if (fingerCount === 4) potentialShape = 'msg4';
        else if (fingerCount === 3) potentialShape = 'msg3';
        else if (fingerCount === 2) potentialShape = 'msg2';
        else if (fingerCount === 1 && indexUp) potentialShape = 'msg1';
        else if (fingerCount === 0) potentialShape = 'idle';

        const bar = document.getElementById('stabilizer-bar');
        
        if (potentialShape !== lastDetectedShape) {
            lastDetectedShape = potentialShape;
            frameCounter = 0;
            bar.style.width = "0%";
            bar.style.background = "#333";
        } else {
            if (frameCounter < STABILITY_THRESHOLD) {
                frameCounter++;
                bar.style.width = (frameCounter / STABILITY_THRESHOLD) * 100 + "%";
            }
        }

        if (frameCounter >= STABILITY_THRESHOLD) {
            bar.style.background = "#00ffaa";
            if (displayedShape !== potentialShape) {
                displayedShape = potentialShape;
                if (potentialShape !== 'idle') triggerTransitionEffect('explode');
                calculateShape(potentialShape);
            }
        }
        
        const pinchDist = Math.hypot(landmarks[8].x - landmarks[4].x, landmarks[8].y - landmarks[4].y);
        return { physics: (pinchDist < 0.05) ? 0.2 : 1.0 };
    }

    function onResults(results) {
        document.getElementById('loading').style.display = 'none';
        
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const state = detectGesture(results.multiHandLandmarks[0]);
            physicsScale = state.physics;
        } else {
            // Jika tangan hilang
            const statusText = document.getElementById('cam-status');
            statusText.innerText = "Mencari Tangan...";
            statusText.classList.remove('ok');
            
            if(displayedShape !== 'idle') {
                calculateShape('idle');
                displayedShape = 'idle';
            }
            document.getElementById('stabilizer-bar').style.width = "0%";
            physicsScale = 1.0;
        }
    }

    const videoElement = document.getElementById('webcam-preview');
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    hands.onResults(onResults);

    const cameraUtils = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 480, height: 360,
        facingMode: 'user'
    });

    initParticles();
    cameraUtils.start();
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        adjustCamera();
    });
</script>
</body>
</html>
